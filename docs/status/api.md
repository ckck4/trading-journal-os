# API Status

## Recent Updates
- **Phase 10 Discipline Foundation**: Added `routine_checkins` database schema, expanded `finance_settings` with `discipline_weights`, and created backend implementation for `/api/discipline/checkin`, `/api/discipline/score`, `/api/discipline/history`, and `/api/discipline/settings` to support daily routines and score tracking.
- **Phase 7 Grading Foundation**: Created database tables `confluences`, `trade_confluences`, and `trade_grades`. Added backend implementation for `/api/confluences`, `/api/confluences/[id]`, `/api/trades/[id]/grade`, and `/api/grading/summary` to support grading logic.
- **Phase 6 Goals & Habits**: Created database tables `goals`, `habits`, and `habit_completions`. Added backend implementation for `/api/goals` and `/api/habits` offering end-to-end CRUD operations synced directly via the Supabase Admin client to respect user_id constraints. Implemented complex habit streaking metrics and goal progress logic dynamically calculated inside the API.
- **Phase 6 Strategies Foundation**: Implemented `strategies` schema migration with new `entry_rules` and `invalidation_conditions` columns. Created `GET`, `POST`, `PATCH`, and `DELETE` endpoints for `/api/strategies`, including profit calculations (`tradeCount`, `totalPnl`, `winRate`, `profitFactor`). Updated `PATCH /api/trades/[id]` to process `strategy_id` assignments. Added Strategy selection dropdown to the trade detail panel.
- **Phase 5 Finance API Implementation**: Completed implementation of all Finance Manager API routes (`/api/finance/expenses`, `/api/finance/subscriptions`, `/api/finance/payouts`, `/api/finance/overview`, `/api/finance/cashflow`, `/api/finance/settings`). The `overview` and `cashflow` endpoints contain complex server-side aggregations mapping expenses, subs, and payouts safely across rolling 6/12 month windows and YTD calculations.
- **Phase 5 Foundation**: Added 5 new schema tables (`expenses`, `subscriptions`, `payouts`, `ledger_entries`, `finance_settings`) with RLS policies, created API route stubs for `/api/finance/*`, `/api/ledger/*`, and `/api/insights/*`, and updated sidebar navigation with placeholder pages.
- **`runImport` Incorrect Account Recalc Fix**: Addressed a critical bug where imported CSVs recalculated PnL against an arbitrary cached/wrong account object (`c039...`) by completely refactoring Step 7.5 to directly select `trade_id` mapping out of `fills` to ensure strict 1:1 `accountId` assignment from verified trades. Corrupt `daily_summaries` were flushed and synced properly.
- **`runImport` Cross-day PnL Recalc Fix**: Fixed a bug where `daily_summaries` was only recalculating the specific trading days present in an imported CSV. Now, `runImport` finds the earliest `trading_day` affected for an account and recalculates ALL subsequent days in chronological order, ensuring `cumulative_pnl` stays perfectly in sync across all dates.
